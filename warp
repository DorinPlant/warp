%%shell
#!/bin/bash

clear
mkdir -p ~/.cloudshell && touch ~/.cloudshell/no-apt-get-warning # Для Google Cloud Shell, но лучше там не выполнять
echo "Установка зависимостей..."
apt update -y && apt install sudo -y # Для Aeza Terminator, там sudo не установлен по умолчанию
sudo apt-get update -y --fix-missing && sudo apt-get install wireguard-tools jq -y --fix-missing # Update второй раз, если sudo установлен и обязателен (в строке выше не сработал)

priv="${1:-$(wg genkey)}"
pub="${2:-$(echo "${priv}" | wg pubkey)}"
api="https://api.cloudflareclient.com/v0i1909051800"
ins() { curl -s -H 'user-agent:' -H 'content-type: application/json' -X "$1" "${api}/$2" "${@:3}"; }
sec() { ins "$1" "$2" -H "authorization: Bearer $3" "${@:4}"; }
response=$(ins POST "reg" -d "{\"install_id\":\"\",\"tos\":\"$(date -u +%FT%T.000Z)\",\"key\":\"${pub}\",\"fcm_token\":\"\",\"type\":\"ios\",\"locale\":\"en_US\"}")

id=$(echo "$response" | jq -r '.result.id')
token=$(echo "$response" | jq -r '.result.token')
response=$(sec PATCH "reg/${id}" "$token" -d '{"warp_enabled":true}')
peer_pub=$(echo "$response" | jq -r '.result.config.peers[0].public_key')
peer_endpoint=$(echo "$response" | jq -r '.result.config.peers[0].endpoint.host')
client_ipv4=$(echo "$response" | jq -r '.result.config.interface.addresses.v4')
client_ipv6=$(echo "$response" | jq -r '.result.config.interface.addresses.v6')

conf=$(cat <<-EOM
[Interface]
PrivateKey = ${priv}
S1 = 0
S2 = 0
Jc = 121
Jmin = 20
Jmax = 140
H1 = 1
H2 = 2
H3 = 3
H4 = 4
Address = ${client_ipv4}, ${client_ipv6}
DNS = 1.1.1.1, 2606:4700:4700::1111, 1.0.0.1, 2606:4700:4700::1001

[Peer]
PublicKey = ${peer_pub}
AllowedIPs = 162.159.0.0/16, 66.22.0.0/16, 8.8.4.0/24, 8.8.8.0/24, 8.34.208.0/20, 8.35.192.0/20, 23.236.48.0/20, 23.251.128.0/19, 34.0.0.0/10, 35.184.0.0/13, 35.192.0.0/14, 35.196.0.0/15, 35.198.0.0/16, 35.199.0.0/17, 35.199.128.0/18, 35.200.0.0/13, 35.208.0.0/12, 64.18.0.0/20, 64.233.160.0/19, 66.102.0.0/20, 66.249.64.0/19, 70.32.128.0/19, 72.14.192.0/18, 74.114.24.0/21, 74.125.0.0/16, 104.132.0.0/23, 104.133.0.0/23, 104.134.0.0/15, 104.156.64.0/18, 104.237.160.0/19, 108.59.80.0/20, 108.170.192.0/18, 108.177.0.0/17, 130.211.0.0/16, 136.112.0.0/12, 142.250.0.0/15, 146.148.0.0/17, 162.216.148.0/22, 162.222.176.0/21, 172.110.32.0/21, 172.217.0.0/16, 172.253.0.0/16, 173.194.0.0/16, 173.255.112.0/20, 192.158.28.0/22, 192.178.0.0/15, 193.186.4.0/24, 199.36.154.0/23, 199.36.156.0/24, 199.192.112.0/22, 199.223.232.0/21, 207.223.160.0/20, 208.65.152.0/22, 208.68.108.0/22, 208.81.188.0/22, 208.117.224.0/19, 209.85.128.0/17, 216.58.192.0/19, 216.239.32.0/19, 216.239.36.0/24, 216.239.38.0/23, 216.239.40.0/22, 104.244.42.0/24, 104.244.43.0/24, 104.244.45.0/24, 104.26.0.0/24, 104.26.1.0/24, 104.26.4.0/24, 104.26.5.0/24, 138.201.219.0/24, 146.75.120.0/24, 151.101.0.0/24, 151.101.128.0/24, 151.101.192.0/24, 151.101.36.0/24, 151.101.64.0/24, 151.101.84.0/24, 152.199.21.0/24, 162.159.140.0/24, 172.66.0.0/24, 172.67.70.0/24, 172.67.74.0/24, 184.31.3.0/24, 185.199.108.0/24, 185.199.109.0/24, 185.199.110.0/24, 185.199.111.0/24, 188.114.98.0/24, 188.114.99.0/24, 192.229.220.0/24, 192.229.233.0/24, 209.237.192.0/24, 209.237.193.0/24, 209.237.194.0/24, 209.237.195.0/24, 209.237.196.0/24, 209.237.197.0/24, 209.237.198.0/24, 209.237.199.0/24, 209.237.200.0/24, 209.237.201.0/24, 209.237.203.0/24, 209.237.204.0/24, 213.230.209.0/24, 23.1.106.0/24, 3.64.163.0/24, 34.241.140.0/24, 34.241.151.0/24, 34.254.1.0/24, 47.243.81.0/24, 47.76.218.0/24, 52.209.105.0/24, 52.209.30.0/24, 52.213.198.0/24, 52.50.112.0/24, 64.32.10.0/24, 69.195.160.0/24, 69.195.162.0/24, 69.195.163.0/24, 69.195.165.0/24, 69.195.166.0/24, 69.195.168.0/24, 69.195.169.0/24, 69.195.171.0/24, 69.195.174.0/24, 69.195.175.0/24, 69.195.176.0/24, 69.195.177.0/24, 69.195.178.0/24, 69.195.179.0/24, 69.195.180.0/24, 69.195.181.0/24, 69.195.182.0/24, 69.195.183.0/24, 69.195.184.0/24, 69.195.185.0/24, 69.195.186.0/24, 69.195.187.0/24, 93.184.220.0/24, 95.173.103.0/24
Endpoint = ${peer_endpoint}
EOM
)

clear
echo -e "\n\n\n"
[ -t 1 ] && echo "########## НАЧАЛО КОНФИГА ##########"
echo "${conf}"
[ -t 1 ] && echo "########### КОНЕЦ КОНФИГА ###########"

conf_base64=$(echo -n "${conf}" | base64 -w 0)
echo "Скачать конфиг файлом: https://immalware.github.io/downloader.html?filename=WARP.conf&content=${conf_base64}"
echo -e "\n"
